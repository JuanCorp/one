<!DOCTYPE html>
<meta charset="utf-8">
<head>

    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/dc/2.1.6/dc.css">
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.1.0/leaflet.css">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    {% load static %}
  <script src="https://code.jquery.com/jquery-3.2.1.js" integrity="sha256-DZAnKJ/6XZ9si04Hgrsxu/8s717jcIzLy3oi35EouyE=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.js"></script>
     <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-geo/1.6.4/d3-geo.js"></script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.js"></script>
  <script src="{% static 'lib/js/bootstrap.min.js' %}"></script>
  <script src="{% static 'lib/js/crossfilter.js' %}"></script>
  <script src="{% static 'lib/js/keen.min.js' %}"></script>
  <script src="{% static 'lib/js/dc.js' %}"></script>
    <script src="{% static 'lib/js/dc-leaflet.js' %}"></script>
  <script src="{% static 'lib/js/dc-tooltip-mixin.min.js' %}"></script>
    <link rel="stylesheet" type="text/css" href="{% static 'lib/css/dc-leaflet-legend.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'lib/css/dc-tooltip-mixin.min.css' %}">

    <style>
        .dc-chart g.row text {fill: black;}
    </style>

</head>
<h2 style="color: white">Total Ubicaciones</h2>
<body style="background-color: black">
<div id = "row-chart">

    <div id = "RD-chart">

    </div>
    <div id = "region-chart">
        <div class="row" style="display: inline;">
            <div class="col-md-6">
                <h4 id = "Title" style="text-align: center">Región</h4>
            </div>
            <div class = "col-md-6">
                <button id = "Back" class="btn btn-primary pull-right">Atrás</button>
            </div>
        </div>
    </div>

</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dc/2.1.6/dc.js"></script>
<script>
            var url = "{% url "INFO_Provincias" %}"
</script>




<script>
    queue()
        .defer(d3.json, url)
        .await(makeGraphs);

    function makeGraphs(error,ProvJson) {
        $("#Back").hide();
        $("#provincia-chart").hide();
        var geoJson = ProvJson["Geo"];
        var cross = crossfilter(ProvJson["Censo"]);

        //Dimensions
        var regionDim = cross.dimension(function(d){return d["Region"]});


        var  dimensiones = ["Region","Provincia","Municipio","Distrito","Seccion","Barrio"];

        var filters = [null,null,null,null,null,null];
        var dims = [null,null,null,null,null,null];
        var coordenadas = [null,null,null,null,null,null];
        //Data Groups

        var all = cross.groupAll();
        var byRegion = regionDim.group();

        var totalByRegion = regionDim.group().reduceSum(function(d) {
            return d["Cantidad"];
        });


        var max_region = totalByRegion.top(1)[0].value;
        console.log(max_region);
        // Graficos

        var MasterChart = dc.rowChart("#region-chart");
        var MapChart = dc.geoChoroplethChart("#RD-chart");

        var base_scale = 10500;
        var translation = 0;

        var center = d3.geo.centroid(geoJson);
        console.log(center);

        MapChart.width(990)
                    .height(500)
                    .dimension(regionDim)
                    .group(totalByRegion)
                    .colors(d3.scale.quantize().range(
                        ["#E2F2FF", "#C4E4FF", "#9ED2FF", "#81C5FF", "#6BBAFF", "#51AEFF", "#36A2FF", "#1E96FF", "#0089FF", "#0061B5"]))
                    .colorDomain([0, max_region])
                    .colorCalculator(function (d) { return d ? MapChart.colors()(d) : '#ccc'; })
            .projection(d3.geo.equirectangular().scale(base_scale).center(center))
                    .overlayGeoJson(geoJson.features, "Region", function (d) {
                        return d.properties.name;
                    });




        MasterChart
        .width(600)
        .height(550)
        .dimension(regionDim)
        .group(totalByRegion)
            .elasticX(true)
        .xAxis().ticks(4);


        function remove_empty_bins(source_group) {
            return {
            all:function () {
                return source_group.all().filter(function(d) {
                    return d.value != 0;
                    });
                }
            };
        }

        var counter = 0;
        var check = false;
        var back = false;


        function resetDimensionFilter (dimension) {
         dimension.filter(null);
        }

        function resetData(ndx, dimensions) {
          // Clear all filters from dimensions, because `ndx.remove`
          // only removes records matching the current filters.
          dimensions.forEach(resetDimensionFilter);

          // Remove all data from the cross filter
          ndx.remove();
        }

        function  get_scale(area){
             var Coordinates;
            console.log(area);
            var features;
            if (counter == 0)
                features = geoJson["features"];
            else
                features = coordenadas[counter]["features"];

            for (i = 0; i < features.length; i++){
                if (features[i]["properties"]["name"] == area)
                {
                    Coordinates = features[i];
                }
            }

            var projection = d3.geo.equirectangular()
                                .scale(1)
                                .translate([0, 0]);

            var path = d3.geo.path()
                .projection(projection);

            var bounds = path.bounds(Coordinates);
            var scale   = .95 / Math.max((bounds[1][0] - bounds[0][0]) / 990, (bounds[1][1] - bounds[0][1]) / 500);
            var offset  = [(990 - scale * (bounds[1][0] + bounds[0][0])) / 2, (500 - scale * (bounds[1][1] + bounds[0][1])) / 2];

            console.log(scale);
            console.log(offset);
            return [scale,offset];
        }

        function get_center(area){
            var Coordinates;
            console.log(area);
            var features;
            if (counter == 0)
                features = geoJson["features"];
            else
                features = coordenadas[counter]["features"];

            for (i = 0; i < features.length; i++){
                if (features[i]["properties"]["name"] == area)
                {
                    Coordinates = features[i];
                }
            }

            var minY = 181;
            var minX = 181;
            var maxY = -181;
            var maxX = -181;
            feature_coordinates = Coordinates["geometry"]["coordinates"][0][0];

            for(j = 0; j < feature_coordinates.length; j++) {
                    x = feature_coordinates[j][0];
                    minX = Math.min(x,minX);
                    maxX = Math.max(x,maxX);

                    y = feature_coordinates[j][1];
                    minY = Math.min(y,minY);
                    maxY = Math.max(y,maxY);

            }
            var centerX = minX + ((maxX - minX) / 2);
            var centerY = minY + ((maxY - minY) / 2);
            console.log(centerX);
            console.log(centerY);
            return [centerX,centerY]
        }

        function get_dim(dimension, area,dim_anterior){
            console.log('Dimension' + dimension);
            console.log(area);
            if (area == null){
                console.log(dims[counter+1]);
                console.log(coordenadas[counter+1]["features"][0]["properties"]);
                return [dims[counter+1],coordenadas[counter + 1]];
            }
            var dim_url = "{% url 'INFO_Ubicacion'%}?ubicacion=" + dimension + "&filtro=" + area + "&anterior="+ dim_anterior;
            var dim_json = $.ajax({
                url: dim_url,
                async: false,
                dataType: 'json'
            }).responseJSON;


            console.log(typeof(dim_json));
            cross.remove();
            cross = crossfilter(dim_json["Censo"]);
            cross.add(dim_json["Censo"]);
            var ubicacion_geoJson = dim_json["Geo"];
            console.log(ubicacion_geoJson["features"][0]["properties"]);
            console.log(d3.geo.centroid(ubicacion_geoJson));
            var ubicacionDim = cross.dimension(function(d){return d[dimension]? d[dimension]:""});
            return [ubicacionDim,ubicacion_geoJson];
        }

        MapChart.on("filtered", function(chart){
            if (counter + 1 == dimensiones.length)
            {
                return;
            }
           filter = chart.filters();
           console.log(filter);
           area = filter[0];
           if (area != null) {
               filters[counter + 1] = area;
               //center = get_center(area);
               map_properties = get_scale(area);
               base_scale = map_properties[0];
               translation = map_properties[1];
           }
           ubicacion  = get_dim(dimensiones[counter + 1],area,dimensiones[counter]);
           currentDim = ubicacion[0];
           currentCoordinates = ubicacion[1];
           currentDim.filter(area);
           MapChart.dimension(currentDim);
           currentVal = currentDim.group().reduceSum(function(d) {return d["Cantidad"];});
           MapChart.group(currentVal);
           if (check == false){
               check = true;
               dims[counter + 1] = currentDim;
               coordenadas[counter + 1] = currentCoordinates;
               MapChart.filter(null);
               //center = d3.geo.centroid(currentCoordinates);
               var max_ubicacion = currentVal.top(1)[0].value;
               MapChart
                   .colors(d3.scale.quantize().range(
                        ["#E2F2FF","#D4E2FF","#C4E4FF","#8DC2FF","#9ED2FF","#61B5FF","#81C5FF", "#6BBAFF","#410EFF",
                            "#51AEFF","#2602FF","#36A2FF","#0#86FF","#1E96FF","9079FF","#0089FF", "#0061B5"]))
                    .colorDomain([0, max_ubicacion])
                    .colorCalculator(function (d) { return d ? MapChart.colors()(d) : '#ccc'; })
                   .projection(d3.geo.equirectangular().scale(base_scale).translate(translation))
                    .overlayGeoJson(coordenadas[counter + 1].features, dimensiones[counter+1], function (d) {
                        console.log(d.properties.name);
                        return d.properties.name;
                    });
               MapChart.render();
               MapChart.redraw();

               counter++;
               if (back == false)
               {
                   back = true;
                   $("#Back").show(100);
               }
           }
           console.log(counter);
           $("#Title").text(dimensiones[counter]);
           check = false;
        });





        $("#Back").click( function (){
            currentDim = dimensions[counter-1];
           console.log(currentDim);
            filter = filters[counter - 1];
            currentDim.filter(filter);
            MasterChart.dimension(currentDim);
            currentVal = values[counter - 1];
            MasterChart.group(remove_empty_bins(currentVal));
            MasterChart.render();
           counter--;
           $("#Title").text(titulos[counter]);
           if (counter == 0)
           {
               $("#Back").hide(100);
               back = false;
           }
        });
        dc.renderAll();



    };
</script>
</body>
</html>